<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>分账项目管理</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-7xl mx-auto p-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-semibold">分账项目管理</h1>
      <!-- 仅按钮，不做交互 -->
      <button id="btnCreateProject" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
        <i class="fa fa-plus mr-2"></i>新增分账项目
      </button>
    </div>

     <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded shadow p-4">
        <div class="text-sm text-gray-500">项目总数</div>
        <div class="text-2xl font-bold" id="statTotal">-</div>
      </div>
      <div class="bg-white rounded shadow p-4">
        <div class="text-sm text-gray-500">待审核</div>
        <div class="text-2xl font-bold" id="statPending">-</div>
      </div>
      <div class="bg-white rounded shadow p-4">
        <div class="text-sm text-gray-500">协议待上传</div>
        <div class="text-2xl font-bold" id="statUpload">-</div>
      </div>
      <div class="bg-white rounded shadow p-4">
        <div class="text-sm text-gray-500">进行中</div>
        <div class="text-2xl font-bold" id="statActive">-</div>
      </div>
    </div>


    <!-- Filters -->
    <div class="bg-white rounded shadow p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div>
          <label class="text-sm text-gray-600">项目状态</label>
          <select class="mt-1 w-full border rounded p-2" id="fStatus">
            <option value="">全部</option>
            <option>草稿</option>
            <option>待审核</option>
            <option>已通过</option>
            <option>协议待上传</option>
            <option>协议待签署</option>
            <option>进行中</option>
            <option>已归档</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-600">开始日期</label>
          <input type="date" class="mt-1 w-full border rounded p-2" id="fStart" />
        </div>
        <div>
          <label class="text-sm text-gray-600">结束日期</label>
          <input type="date" class="mt-1 w-full border rounded p-2" id="fEnd" />
        </div>
        <div>
          <label class="text-sm text-gray-600">所属账户/组织</label>
          <input type="text" placeholder="示例：主账户/渠道部" class="mt-1 w-full border rounded p-2" id="fAccount" />
        </div>
        <div>
          <label class="text-sm text-gray-600">负责人</label>
          <input type="text" placeholder="示例：张三" class="mt-1 w-full border rounded p-2" id="fOwner" />
        </div>
      </div>
      <div class="mt-4 flex gap-3">
        <button id="btnFilter" class="px-3 py-2 bg-gray-800 text-white rounded">筛选</button>
        <button id="btnReset" class="px-3 py-2 bg-gray-200 text-gray-800 rounded">重置</button>
      </div>
    </div>

    <!-- Projects Table -->
    <div class="bg-white rounded shadow overflow-hidden">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <h2 class="font-semibold">项目列表</h2>
        <div class="text-sm text-gray-600">点击列操作按钮以查看或处理（暂不接交互）</div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">项目编号</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">项目名称</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">所属账户</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">负责人</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">状态</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">创建时间</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">总收入</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">已分账</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">异常/重试</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">操作</th>
            </tr>
          </thead>
          <tbody id="tbodyProjects" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 新增/编辑分账项目 模态框 -->
  <div id="modalCreateEdit" class="fixed inset-0 z-50 hidden" aria-hidden="true">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-2xl bg-white rounded-lg shadow-lg">
        <div class="px-6 py-4 border-b">
          <h3 id="modalCreateEditTitle" class="text-lg font-semibold">新增分账项目</h3>
        </div>
        <div class="px-6 py-4 space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-600 mb-1">项目名称<span class="text-red-500">*</span></label>
              <input id="f_name" type="text" class="w-full border rounded px-3 py-2" placeholder="请输入项目名称" />
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">状态</label>
              <select id="f_status" class="w-full border rounded px-3 py-2">
                <option value="草稿">草稿</option>
                <option value="待审核">待审核</option>
                <option value="进行中">进行中</option>
                <option value="已终止">已终止</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">所属组织/账户</label>
              <input id="f_account" type="text" class="w-full border rounded px-3 py-2" placeholder="如：渠道A / 区域B" />
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">负责人</label>
              <input id="f_owner" type="text" class="w-full border rounded px-3 py-2" placeholder="请输入负责人" />
            </div>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">项目描述</label>
            <textarea id="f_desc" class="w-full border rounded px-3 py-2" rows="3" placeholder="补充项目背景、参与方、分账依据等"></textarea>
          </div>
          <p id="formError" class="text-red-600 text-sm hidden">请填写必填项：项目名称</p>
        </div>
        <div class="px-6 py-4 border-t flex justify-end gap-3">
          <button id="btnCancelCreateEdit" class="px-4 py-2 rounded border">取消</button>
          <button id="btnSaveCreateEdit" class="px-4 py-2 rounded bg-blue-600 text-white">保存</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 项目详情 模态框 -->
  <div id="modalDetail" class="fixed inset-0 z-50 hidden" aria-hidden="true">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-2xl bg-white rounded-lg shadow-lg">
        <div class="px-6 py-4 border-b">
          <h3 class="text-lg font-semibold">项目详情</h3>
        </div>
        <div class="px-6 py-4 space-y-3">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div><span class="text-gray-500">项目编号：</span><span id="d_id" class="font-medium"></span></div>
            <div><span class="text-gray-500">项目名称：</span><span id="d_name" class="font-medium"></span></div>
            <div><span class="text-gray-500">状态：</span><span id="d_status" class="font-medium"></span></div>
            <div><span class="text-gray-500">所属组织/账户：</span><span id="d_account" class="font-medium"></span></div>
            <div><span class="text-gray-500">负责人：</span><span id="d_owner" class="font-medium"></span></div>
            <div><span class="text-gray-500">创建时间：</span><span id="d_createdAt" class="font-medium"></span></div>
          </div>
          <div class="text-sm">
            <div class="text-gray-500 mb-1">项目描述：</div>
            <div id="d_desc" class="whitespace-pre-wrap"></div>
          </div>
        </div>
        <div class="px-6 py-4 border-t flex justify-end">
          <button id="btnCloseDetail" class="px-4 py-2 rounded border">关闭</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 示例项目数据（仅用于原型展示）
    const projects = [
      {id: 'P2025-001', name: '渠道分账项目A', account: '主账户', owner: '张三', status: '草稿', createdAt: '2025-10-18', revenue: 120000, allocated: 56000, issues: 1, retries: 0},
      {id: 'P2025-002', name: 'BD合作项目B', account: '渠道部', owner: '李四', status: '待审核', createdAt: '2025-10-19', revenue: 85000, allocated: 32000, issues: 0, retries: 0},
      {id: 'P2025-003', name: '直营分账项目C', account: '直营部', owner: '王五', status: '协议待上传', createdAt: '2025-10-20', revenue: 230000, allocated: 180000, issues: 2, retries: 1},
      {id: 'P2025-004', name: '平台结算项目D', account: '结算中心', owner: '赵六', status: '进行中', createdAt: '2025-10-11', revenue: 410000, allocated: 398000, issues: 3, retries: 2},
      {id: 'P2025-005', name: '渠道分账项目E', account: '主账户', owner: '钱七', status: '已归档', createdAt: '2025-09-30', revenue: 76000, allocated: 76000, issues: 0, retries: 0}
    ];

    // 确保projects变量在全局范围内可访问
    //window.projects = projects;

    const statusBadge = (s) => {
      const map = {
        '草稿': 'bg-gray-200 text-gray-800',
        '待审核': 'bg-yellow-100 text-yellow-800',
        '已通过': 'bg-green-100 text-green-800',
        '协议待上传': 'bg-blue-100 text-blue-800',
        '协议待签署': 'bg-indigo-100 text-indigo-800',
        '进行中': 'bg-green-200 text-green-900',
        '已归档': 'bg-gray-100 text-gray-600'
      };
      return `<span class="px-2 py-1 rounded text-xs ${map[s]||'bg-gray-100'}">${s}</span>`;
    };

     function render(list) {
       const tbody = document.getElementById('tbodyProjects');
       if (!tbody) return;
       
       tbody.innerHTML = list.map(p => `
         <tr>
           <td class="px-4 py-2 text-sm">${p.id}</td>
           <td class="px-4 py-2 text-sm">${p.name}</td>
           <td class="px-4 py-2 text-sm">${p.account}</td>
           <td class="px-4 py-2 text-sm">${p.owner}</td>
           <td class="px-4 py-2 text-sm">${statusBadge(p.status)}</td>
           <td class="px-4 py-2 text-sm">${p.createdAt}</td>
           <td class="px-4 py-2 text-sm">¥${(p.revenue).toLocaleString()}</td>
           <td class="px-4 py-2 text-sm">¥${(p.allocated).toLocaleString()}</td>
           <td class="px-4 py-2 text-sm">${p.issues}/${p.retries}</td>
           <td class="px-4 py-2 text-sm">
             <div class="flex flex-wrap gap-2">
               <button class="btn-detail px-2 py-1 bg-gray-100 rounded text-xs" data-id="${p.id}">详情</button>
               ${getActionButtons(p)}
               <button class="btn-edit px-2 py-1 bg-green-100 rounded text-xs" data-id="${p.id}">编辑</button>
               <button class="btn-delete px-2 py-1 bg-red-100 rounded text-xs" data-id="${p.id}">删除</button>
             </div>
           </td>
         </tr>
       `).join('');

       document.getElementById('statTotal').textContent = list.length;
       document.getElementById('statPending').textContent = list.filter(x => x.status === '待审核').length;
       document.getElementById('statUpload').textContent = list.filter(x => x.status === '协议待上传').length;
       document.getElementById('statActive').textContent = list.filter(x => x.status === '进行中').length;
     }

     // 根据项目状态生成对应的操作按钮
     function getActionButtons(project) {
       const buttons = [];
       
       switch (project.status) {
         case '待审核':
           buttons.push('<button class="btn-review px-2 py-1 bg-yellow-100 rounded text-xs" data-id="' + project.id + '">审核</button>');
           break;
         case '已通过':
           buttons.push('<button class="btn-upload px-2 py-1 bg-blue-100 rounded text-xs" data-id="' + project.id + '">上传协议</button>');
           break;
         case '协议待签署':
           buttons.push('<button class="btn-sign px-2 py-1 bg-indigo-100 rounded text-xs" data-id="' + project.id + '">协议签署</button>');
           break;
         default:
           // 其他状态显示禁用的按钮
           buttons.push('<button class="px-2 py-1 bg-yellow-100 rounded text-xs opacity-50 cursor-not-allowed" disabled>审核</button>');
           buttons.push('<button class="px-2 py-1 bg-blue-100 rounded text-xs opacity-50 cursor-not-allowed" disabled>上传协议</button>');
           buttons.push('<button class="px-2 py-1 bg-indigo-100 rounded text-xs opacity-50 cursor-not-allowed" disabled>协议签署</button>');
           break;
       }
       
       return buttons.join('');
     }

    function applyFilter() {
      const s = document.getElementById('fStatus').value.trim();
      const a = document.getElementById('fAccount').value.trim();
      const o = document.getElementById('fOwner').value.trim();
      const start = document.getElementById('fStart').value;
      const end = document.getElementById('fEnd').value;

      const filtered = projects.filter(p => {
        const byStatus = !s || p.status === s;
        const byAcc = !a || p.account.includes(a);
        const byOwner = !o || p.owner.includes(o);
        const byDate = (!start || p.createdAt >= start) && (!end || p.createdAt <= end);
        return byStatus && byAcc && byOwner && byDate;
      });
      render(filtered);
    }

    document.getElementById('btnFilter').addEventListener('click', applyFilter);
    document.getElementById('btnReset').addEventListener('click', () => {
      ['fStatus','fAccount','fOwner','fStart','fEnd'].forEach(id => document.getElementById(id).value = '');
      render(projects);
    });

    // 事件绑定：操作列事件代理
    const tbody = document.getElementById('tbodyProjects');
    if (tbody) {
      tbody.addEventListener('click', (e) => {
        const t = e.target;
        if (t && t.classList.contains('btn-detail')) {
          const id = t.getAttribute('data-id');
          openDetailModal(id);
        } else if (t && t.classList.contains('btn-edit')) {
          const id = t.getAttribute('data-id');
          openEditModal(id);
        } else if (t && t.classList.contains('btn-review')) {
          const id = t.getAttribute('data-id');
          openReviewModal(id);
        } else if (t && t.classList.contains('btn-upload')) {
          const id = t.getAttribute('data-id');
          openUploadModal(id);
        } else if (t && t.classList.contains('btn-sign')) {
          const id = t.getAttribute('data-id');
          openSignModal(id);
        } else if (t && t.classList.contains('btn-delete')) {
          const id = t.getAttribute('data-id');
          openDeleteModal(id);
        }
      });
    }
    
    // 模态按钮事件
    const btnCancelCreateEdit = document.getElementById('btnCancelCreateEdit');
    const btnSaveCreateEdit = document.getElementById('btnSaveCreateEdit');
    const btnCloseDetail = document.getElementById('btnCloseDetail');
    if (btnCancelCreateEdit) btnCancelCreateEdit.addEventListener('click', () => closeModal('modalCreateEdit'));
    if (btnSaveCreateEdit) btnSaveCreateEdit.addEventListener('click', saveCreateEdit);
    if (btnCloseDetail) btnCloseDetail.addEventListener('click', () => closeModal('modalDetail'));
    
    // 通用模态开关
    function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    
    // 生成项目编号，如 P2025-006
    function genNextProjectId() {
      const year = new Date().getFullYear();
      let maxSeq = 0;
      (window.projects || []).forEach(p => {
        const m = String(p.id || '').match(/^P(\d{4})-(\d{3})$/);
        if (m && Number(m[1]) === year) {
          maxSeq = Math.max(maxSeq, Number(m[2]));
        }
      });
      const next = (maxSeq + 1).toString().padStart(3, '0');
      return `P${year}-${next}`;
    }
    
    // 打开新增
    function openCreateModal() {
      document.getElementById('modalCreateEditTitle').textContent = '新增分账项目';
      document.getElementById('formError').classList.add('hidden');
      const modal = document.getElementById('modalCreateEdit');
      modal.dataset.mode = 'create';
      modal.dataset.id = '';
      document.getElementById('f_name').value = '';
      document.getElementById('f_status').value = '草稿';
      document.getElementById('f_account').value = '';
      document.getElementById('f_owner').value = '';
      document.getElementById('f_desc').value = '';
      openModal('modalCreateEdit');
    }
    
    // 打开编辑
    function openEditModal(id) {
      const p = (window.projects || []).find(x => x.id === id);
      if (!p) return;
      document.getElementById('modalCreateEditTitle').textContent = `编辑分账项目：${p.id}`;
      document.getElementById('formError').classList.add('hidden');
      const modal = document.getElementById('modalCreateEdit');
      modal.dataset.mode = 'edit';
      modal.dataset.id = id;
      document.getElementById('f_name').value = p.name || '';
      document.getElementById('f_status').value = p.status || '草稿';
      document.getElementById('f_account').value = p.account || '';
      document.getElementById('f_owner').value = p.owner || '';
      document.getElementById('f_desc').value = p.desc || '';
      openModal('modalCreateEdit');
    }
    
    // 打开详情
    function openDetailModal(id) {
      const p = (window.projects || []).find(x => x.id === id);
      if (!p) return;
      document.getElementById('d_id').textContent = p.id || '';
      document.getElementById('d_name').textContent = p.name || '';
      document.getElementById('d_status').textContent = p.status || '';
      document.getElementById('d_account').textContent = p.account || '';
      document.getElementById('d_owner').textContent = p.owner || '';
      document.getElementById('d_createdAt').textContent = p.createdAt || '';
      document.getElementById('d_desc').textContent = p.desc || '';
      openModal('modalDetail');
    }

    // 事件绑定：新增按钮
    const btnCreateProject = document.getElementById('btnCreateProject');
    if (btnCreateProject) {
      btnCreateProject.addEventListener('click', () => {
        window.location.href = 'allocation-mindmap.html';
      });
    }
   
    // 页面加载完成后进行一次渲染（恢复早期简化逻辑）
   // document.addEventListener('DOMContentLoaded', function() {
     // render(projects);
    //});

    
    // 移除页面已加载立即渲染的冗余逻辑（恢复早期版本）
    // if (document.readyState === 'complete' || document.readyState === 'interactive') {
    //   setTimeout(() => render(projects), 0);
    // }
    
    // 保存新增/编辑
    function saveCreateEdit() {
      const name = document.getElementById('f_name').value.trim();
      if (!name) {
        document.getElementById('formError').classList.remove('hidden');
        return;
      }
      
      const modal = document.getElementById('modalCreateEdit');
      const mode = modal.dataset.mode;
      const id = modal.dataset.id;
      
      const data = {
        name,
        status: document.getElementById('f_status').value,
        account: document.getElementById('f_account').value.trim(),
        owner: document.getElementById('f_owner').value.trim(),
        desc: document.getElementById('f_desc').value.trim()
      };
      
      if (mode === 'create') {
        const newProject = {
          id: genNextProjectId(),
          ...data,
          createdAt: new Date().toISOString().split('T')[0],
          revenue: 0,
          allocated: 0,
          issues: 0,
          retries: 0
        };
        projects.push(newProject);
      } else if (mode === 'edit') {
        const idx = projects.findIndex(p => p.id === id);
        if (idx >= 0) {
          Object.assign(projects[idx], data);
        }
      }
      
      closeModal('modalCreateEdit');
      applyFilter();
    }

    // 审核相关变量
    let currentReviewId = null;

    // 打开审核模态框
    function openReviewModal(id) {
      const p = projects.find(x => x.id === id);
      if (!p) return;
      
      currentReviewId = id;
      
      // 使用Tailwind模态框样式
      const modal = document.createElement('div');
      modal.id = 'modalReview';
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4">
          <div class="px-6 py-4 border-b">
            <h3 class="text-lg font-semibold">审核分账项目</h3>
          </div>
          <div class="px-6 py-4 space-y-4">
            <div>
              <label class="block text-sm text-gray-600 mb-1">项目名称</label>
              <input type="text" class="w-full border rounded px-3 py-2 bg-gray-50" value="${p.name}" readonly>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">当前状态</label>
              <input type="text" class="w-full border rounded px-3 py-2 bg-gray-50" value="${p.status}" readonly>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">审核结果 <span class="text-red-500">*</span></label>
              <select id="reviewResult" class="w-full border rounded px-3 py-2" required>
                <option value="">请选择审核结果</option>
                <option value="approved">通过</option>
                <option value="rejected">驳回</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">审核意见</label>
              <textarea id="reviewComment" class="w-full border rounded px-3 py-2" rows="3" placeholder="请输入审核意见..."></textarea>
            </div>
          </div>
          <div class="px-6 py-4 border-t flex justify-end gap-3">
            <button onclick="closeReviewModal()" class="px-4 py-2 rounded border">取消</button>
            <button onclick="submitReview()" class="px-4 py-2 rounded bg-blue-600 text-white">提交审核</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // 初始化审核表单控件
      const resultEl = document.getElementById('reviewResult');
      const commentEl = document.getElementById('reviewComment');
      if (resultEl) resultEl.value = '';
      if (commentEl) commentEl.value = '';
    }

    // 关闭审核模态框
    function closeReviewModal() {
      const modal = document.getElementById('modalReview');
      if (modal) {
        modal.remove();
      }
      currentReviewId = null;
    }

    // 提交审核
    function submitReview() {
      const result = document.getElementById('reviewResult').value;
      const comment = document.getElementById('reviewComment').value.trim();
      
      if (!result) {
        alert('请选择审核结果');
        return;
      }
      
      const idx = projects.findIndex(p => p.id === currentReviewId);
      if (idx >= 0) {
        if (result === 'approved') {
          projects[idx].status = '已通过';
        } else if (result === 'rejected') {
          projects[idx].status = '草稿';
        }
        projects[idx].reviewComment = comment;
        projects[idx].reviewDate = new Date().toISOString().split('T')[0];
      }
      
      closeReviewModal();
      applyFilter();
      alert(`审核${result === 'approved' ? '通过' : '驳回'}成功！`);
    }

    // 上传协议相关变量
    let currentUploadId = null;

    // 打开上传协议模态框
    function openUploadModal(id) {
      const p = projects.find(x => x.id === id);
      if (!p) return;
      
      currentUploadId = id;
      
      const modal = document.createElement('div');
      modal.id = 'modalUpload';
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4">
          <div class="px-6 py-4 border-b">
            <h3 class="text-lg font-semibold">上传分账协议</h3>
          </div>
          <div class="px-6 py-4 space-y-4">
            <div>
              <label class="block text-sm text-gray-600 mb-1">项目名称</label>
              <input type="text" class="w-full border rounded px-3 py-2 bg-gray-50" value="${p.name}" readonly>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">协议文件 <span class="text-red-500">*</span></label>
              <input type="file" id="agreementFile" class="w-full border rounded px-3 py-2" accept=".pdf,.doc,.docx" required>
              <div class="text-xs text-gray-500 mt-1">支持格式：PDF、DOC、DOCX，文件大小不超过10MB</div>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">协议说明</label>
              <textarea id="agreementDescription" class="w-full border rounded px-3 py-2" rows="3" placeholder="请输入协议说明..."></textarea>
            </div>
            <div id="uploadProgress" class="hidden">
              <label class="block text-sm text-gray-600 mb-1">上传进度</label>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progressBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
              </div>
            </div>
          </div>
          <div class="px-6 py-4 border-t flex justify-end gap-3">
            <button onclick="closeUploadModal()" class="px-4 py-2 rounded border">取消</button>
            <button onclick="uploadAgreement()" class="px-4 py-2 rounded bg-blue-600 text-white">上传协议</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // 关闭上传协议模态框
    function closeUploadModal() {
      const modal = document.getElementById('modalUpload');
      if (modal) {
        modal.remove();
      }
      currentUploadId = null;
    }

    // 上传协议
    function uploadAgreement() {
      const fileInput = document.getElementById('agreementFile');
      const description = document.getElementById('agreementDescription').value.trim();
      
      if (!fileInput.files.length) {
        alert('请选择协议文件');
        return;
      }
      
      const file = fileInput.files[0];
      if (file.size > 10 * 1024 * 1024) {
        alert('文件大小不能超过10MB');
        return;
      }
      
      // 模拟上传进度
      const progressDiv = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('progressBar');
      progressDiv.classList.remove('hidden');
      
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 30;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          
          // 更新项目状态
          const idx = projects.findIndex(p => p.id === currentUploadId);
          if (idx >= 0) {
            projects[idx].status = '协议待签署';
            projects[idx].agreementFile = file.name;
            projects[idx].agreementDescription = description;
            projects[idx].uploadDate = new Date().toISOString().split('T')[0];
          }
          
          setTimeout(() => {
            closeUploadModal();
            applyFilter();
            alert('协议上传成功！');
          }, 500);
        }
        progressBar.style.width = progress + '%';
      }, 200);
    }

    // 协议签署相关变量
    let currentSignId = null;

    // 打开协议签署模态框
    function openSignModal(id) {
      const p = projects.find(x => x.id === id);
      if (!p) return;
      
      currentSignId = id;
      
      const modal = document.createElement('div');
      modal.id = 'modalSign';
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl mx-4">
          <div class="px-6 py-4 border-b">
            <h3 class="text-lg font-semibold">协议签署</h3>
          </div>
          <div class="px-6 py-4 space-y-4">
            <div>
              <label class="block text-sm text-gray-600 mb-1">项目名称</label>
              <input type="text" class="w-full border rounded px-3 py-2 bg-gray-50" value="${p.name}" readonly>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">协议文件</label>
              <div class="flex items-center gap-3">
                <span class="text-sm">${p.agreementFile || '分账协议.pdf'}</span>
                <button onclick="previewAgreement()" class="px-3 py-1 text-xs bg-blue-100 text-blue-800 rounded">预览</button>
              </div>
            </div>
            <div>
              <label class="flex items-center gap-2">
                <input type="checkbox" id="agreeTerms" required>
                <span class="text-sm">我已仔细阅读并同意上述协议内容，确认进行电子签署</span>
              </label>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-2">签署方式</label>
              <div class="grid grid-cols-2 gap-4">
                <label class="flex items-center gap-2">
                  <input type="radio" name="signMethod" value="sms" checked>
                  <span class="text-sm">短信验证码签署</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="radio" name="signMethod" value="cert">
                  <span class="text-sm">数字证书签署</span>
                </label>
              </div>
            </div>
            <div id="smsVerification">
              <label class="block text-sm text-gray-600 mb-1">手机号码</label>
              <div class="flex gap-2">
                <input type="tel" id="phoneNumber" class="flex-1 border rounded px-3 py-2" placeholder="请输入手机号码">
                <button onclick="sendSmsCode()" class="px-4 py-2 bg-gray-200 rounded text-sm">发送验证码</button>
              </div>
              <div class="mt-2">
                <input type="text" id="smsCode" class="w-full border rounded px-3 py-2" placeholder="请输入验证码">
              </div>
            </div>
          </div>
          <div class="px-6 py-4 border-t flex justify-end gap-3">
            <button onclick="closeSignModal()" class="px-4 py-2 rounded border">取消</button>
            <button onclick="signAgreement()" class="px-4 py-2 rounded bg-green-600 text-white">确认签署</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // 关闭协议签署模态框
    function closeSignModal() {
      const modal = document.getElementById('modalSign');
      if (modal) {
        modal.remove();
      }
      currentSignId = null;
    }

    // 发送短信验证码
    function sendSmsCode() {
      const phone = document.getElementById('phoneNumber').value.trim();
      if (!phone) { alert('请输入手机号码'); return; }
      if (!/^1[3-9]\d{9}$/.test(phone)) { alert('请输入正确的手机号码'); return; }
      alert('验证码已发送到您的手机，请注意查收');
    }

    // 预览协议
    function previewAgreement() {
      alert('协议预览功能（模拟）：在实际应用中，这里会打开协议文件的预览窗口');
    }

    // 协议签署
    function signAgreement() {
      const agreeTerms = document.getElementById('agreeTerms').checked;
      const smsCode = document.getElementById('smsCode').value.trim();
      
      if (!agreeTerms) { alert('请先同意协议条款'); return; }
      if (!smsCode) { alert('请输入短信验证码'); return; }
      if (smsCode !== '123456') { alert('验证码错误'); return; }
      
      // 更新项目状态
      const idx = projects.findIndex(p => p.id === currentSignId);
      if (idx >= 0) {
        projects[idx].status = '进行中';
        projects[idx].signDate = new Date().toISOString().split('T')[0];
      }
      
      closeSignModal();
      applyFilter();
      alert('协议签署成功！项目已进入执行阶段');
    }

    // 删除相关变量
    let currentDeleteId = null;

    // 打开删除确认模态框
    function openDeleteModal(id) {
      const p = projects.find(x => x.id === id);
      if (!p) return;
      
      currentDeleteId = id;
      
      const modal = document.createElement('div');
      modal.id = 'modalDelete';
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4">
          <div class="px-6 py-4 border-b">
            <h3 class="text-lg font-semibold">删除确认</h3>
          </div>
          <div class="px-6 py-4">
            <div class="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4">
              <div class="flex items-center gap-2">
                <i class="fa fa-exclamation-triangle text-yellow-600"></i>
                <strong class="text-yellow-800">警告：此操作不可撤销！</strong>
              </div>
            </div>
            <p class="mb-2">确定要删除项目 <strong>${p.name}</strong> 吗？</p>
            <p class="text-sm text-gray-600">删除后，该项目的所有相关数据将被永久删除。</p>
          </div>
          <div class="px-6 py-4 border-t flex justify-end gap-3">
            <button onclick="closeDeleteModal()" class="px-4 py-2 rounded border">取消</button>
            <button onclick="confirmDelete()" class="px-4 py-2 rounded bg-red-600 text-white">确认删除</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // 关闭删除确认模态框
    function closeDeleteModal() {
      const modal = document.getElementById('modalDelete');
      if (modal) {
        modal.remove();
      }
      currentDeleteId = null;
    }

    // 确认删除
    function confirmDelete() {
      const idx = projects.findIndex(p => p.id === currentDeleteId);
      if (idx >= 0) projects.splice(idx, 1);
      closeDeleteModal();
      applyFilter();
      alert('项目删除成功！');
    }