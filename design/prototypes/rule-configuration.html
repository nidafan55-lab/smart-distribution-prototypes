<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>规则配置 - 智能分账系统</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.35); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal { background: #fff; border-radius: .5rem; width: 860px; max-width: 90vw; box-shadow: 0 10px 25px rgba(0,0,0,.15); }
    .input { border: 1px solid #d1d5db; border-radius: .375rem; padding: .5rem .75rem; width: 100%; }
    .label { font-size: .875rem; color: #6b7280; }
    .hidden { display: none; }
  </style>
  </head>
<body class="bg-gray-100">
  <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold">分账规则配置</h1>
        <button id="btnAddRule" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">
          <i class="fas fa-plus mr-2"></i>新建规则
        </button>
      </div>

      <!-- 规则卡片栅格 -->
      <div id="rulesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      <div id="emptyState" class="text-center text-gray-500 py-12 hidden">
        <i class="fas fa-info-circle"></i>
        <p class="mt-2">暂无规则，请点击“新建规则”进行配置</p>
      </div>
    </div>
  </div>

  <!-- 新增/编辑规则 模态框 -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="p-6 border-b flex items-center justify-between">
        <h2 id="modalTitle" class="text-xl font-semibold">新建规则</h2>
        <button id="btnCloseModal" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 space-y-4">
        <div id="simpleNewRuleSection" class="space-y-4 hidden">
          <div class="text-sm font-medium text-gray-700">基础信息</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="label">规则名称</label>
              <input id="simpleRuleName" class="input" placeholder="请输入规则名称" />
            </div>
            <div>
              <label class="label">项目类型</label>
              <select id="simpleProjectType" class="input">
                <option value="current">活期项目</option>
                <option value="fixed">定期项目</option>
              </select>
            </div>
            <div>
              <label class="label">生效时间</label>
              <input id="simpleEffectiveTime" type="datetime-local" class="input" />
            </div>
            <div id="simpleExpireWrap" class="md:col-span-3">
              <label class="label">失效时间</label>
              <input id="simpleExpireTime" type="datetime-local" class="input" />
            </div>
          </div>
          <div class="text-sm font-medium text-gray-700">账目设置</div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="label">账目类型</label>
              <select id="simpleLedgerScopeType" class="input">
                <option value="single">单门店账目</option>
                <option value="multi">多门店账目</option>
              </select>
            </div>
          </div>
        </div>
        <div id="advancedRuleSection">
        <div class="text-sm font-medium text-gray-700">基础信息</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="label">规则名称</label>
            <input id="ruleName" class="input" placeholder="例如：标准分账规则" />
          </div>
          <div></div>
        </div>

        <div class="text-sm font-medium text-gray-700">账目设置</div>
        <div class="grid grid-cols-2 gap-6">
          <div>
            <div class="text-sm text-gray-600 mb-2">活期账目 - 结算分账时间设置</div>
            <div class="inline-flex items-center border rounded-lg overflow-hidden w-full">
              <span class="px-3 py-2 bg-gray-100 text-sm text-gray-600">结算方式</span>
              <select id="currentSettlementType" class="px-3 py-2 text-sm focus:outline-none flex-1"></select>
            </div>
            <div class="text-sm text-gray-600 mt-4 mb-2">活期账目 - 详细设置</div>
            <div id="currentSettlementFields" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
          </div>
          <div>
            <div class="text-sm text-gray-600 mb-2">定期账目 - 结算分账时间设置</div>
            <div class="inline-flex items-center border rounded-lg overflow-hidden w-full">
              <span class="px-3 py-2 bg-gray-100 text-sm text-gray-600">结算方式</span>
              <select id="fixedSettlementType" class="px-3 py-2 text-sm focus:outline-none flex-1"></select>
            </div>
            <div class="text-sm text-gray-600 mt-4 mb-2">定期账目 - 详细设置</div>
            <div id="fixedSettlementFields" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="label">规则类型</label>
            <select id="ruleTypePrimary" class="input">
              <option value="ratio">按比例</option>
              <option value="amount">按金额</option>
              <option value="mixed">混合账目</option>
              <option value="custom">自定义</option>
            </select>
          </div>
          <div id="ruleTypeSecondaryWrap">
            <label class="label">分成方式</label>
            <select id="ruleTypeSecondary" class="input">
              <option value="normal">常规分成</option>
              <option value="ladder">阶梯式分成</option>
            </select>
          </div>
        </div>

        <div id="customConfigSection" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="label">保证金额度（倍数 - 最小）</label>
                <input id="minMultiplier" type="number" step="0.1" min="0" class="input" placeholder="如 1.0" />
              </div>
              <div>
                <label class="label">保证金额度（倍数 - 最大）</label>
                <input id="maxMultiplier" type="number" step="0.1" min="0" class="input" placeholder="如 3.0" />
              </div>
            </div>
            <div></div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="label">分账方式</label>
              <select id="splitMethod" class="input">
                <option value="manual">手动分账</option>
                <option value="auto">自动分账</option>
              </select>
            </div>
          </div>
        </div>
        </div>
      </div>
      <div class="p-6 border-t flex justify-end space-x-3">
        <button id="btnCancel" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded">取消</button>
        <button id="btnSave" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">保存</button>
      </div>
    </div>
  </div>

  <script>
    // 数据模型
    const storageKey = 'ruleConfigRules';
    let rules = [];
    let editIndex = null; // null 表示新增

    function loadRules(){
      try { rules = JSON.parse(localStorage.getItem(storageKey) || '[]'); } catch(e){ rules = []; }
    }
    function saveRules(){ localStorage.setItem(storageKey, JSON.stringify(rules)); }

    // 文本描述
    function settlementTextGeneric(typeLabel, settlement){
      if (!settlement) return `${typeLabel}：未设置`;
      const type = settlement.type;
      if (typeLabel === '活期'){
        if (type === 'order') return `活期：按订单结算，每笔订单结束后 ${settlement.orderDays} 天到账`;
        if (type === 'month') return `活期：按月结算，每月 ${settlement.monthDay} 号结算`;
        if (type === 'year') return `活期：按年结算，每年 ${settlement.yearMonth} 月 ${settlement.yearDay} 号结算`;
      } else {
        if (type === 'order') return `定期：按订单结算，每笔订单结束后 ${settlement.orderDays} 天到账`;
        if (type === 'month') return `定期：按月结算，每月 ${settlement.monthDay} 号结算`;
        if (type === 'revenue_end') return `定期：营收时间结束后统一结算，结束后 ${settlement.revenueEndDays} 天结算`;
      }
      return `${typeLabel}：未设置`;
    }

    // 渲染卡片
    function renderRules(){
      const grid = document.getElementById('rulesGrid');
      const empty = document.getElementById('emptyState');
      grid.innerHTML = '';
      if (!rules.length){ empty.classList.remove('hidden'); return; }
      empty.classList.add('hidden');
      rules.forEach((rule, idx) => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg shadow p-4 flex flex-col';
        card.innerHTML = `
          <div class="flex items-start justify-between">
            <div>
              <h3 class="text-lg font-semibold">${rule.name || '未命名规则'}</h3>
              <p class="text-sm text-gray-500 mt-1">保证金额度：按分账金额的 ${Number(rule.minMultiplier || 0)} 倍到 ${Number(rule.maxMultiplier || 0)} 倍</p>
            </div>
          </div>
          <div class="mt-3 text-sm">
            <p class="mt-1"><span class="text-gray-500">活期结算设置：</span>${settlementTextGeneric('活期', rule.current)}</p>
            <p class="mt-1"><span class="text-gray-500">定期结算设置：</span>${settlementTextGeneric('定期', rule.fixed)}</p>
            <p class="mt-1"><span class="text-gray-500">分账方式：</span>${rule.splitMethod === 'auto' ? '自动分账' : '手动分账'}</p>
          </div>
          <div class="mt-4 text-right">
            <button class="px-3 py-1 text-blue-600 hover:text-blue-800" data-action="edit" data-index="${idx}"><i class="fas fa-edit"></i> 编辑</button>
            <button class="px-3 py-1 text-red-600 hover:text-red-800" data-action="delete" data-index="${idx}"><i class="fas fa-trash"></i> 删除</button>
          </div>
        `;
        grid.appendChild(card);
      });

      // 绑定卡片按钮
      grid.querySelectorAll('button[data-action="edit"]').forEach(btn => {
        btn.addEventListener('click', () => openModal(parseInt(btn.getAttribute('data-index'), 10)));
      });
      grid.querySelectorAll('button[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = parseInt(btn.getAttribute('data-index'), 10);
          if (confirm('确认删除该规则吗？')){
            rules.splice(i,1); saveRules(); renderRules();
          }
        });
      });
    }

    // 模态框逻辑
    function openModal(index=null){
      editIndex = index;
      document.getElementById('modalBackdrop').style.display = 'flex';
      document.getElementById('modalTitle').textContent = index===null ? '新建规则' : '编辑规则';

      const isNew = index === null;
      const simple = document.getElementById('simpleNewRuleSection');
      const adv = document.getElementById('advancedRuleSection');
      if (isNew){
        if (simple) simple.classList.remove('hidden');
        if (adv) adv.classList.add('hidden');
        const rn = document.getElementById('simpleRuleName');
        const pt = document.getElementById('simpleProjectType');
        const st = document.getElementById('simpleEffectiveTime');
        const et = document.getElementById('simpleExpireTime');
        const lt = document.getElementById('simpleLedgerScopeType');
        if (rn) rn.value = '节假日活动营收分成';
        if (pt) pt.value = 'fixed';
        if (st) st.value = '2025-11-19T00:00';
        if (et) et.value = '';
        if (lt) lt.value = 'single';
        const sv = pt ? pt.value : 'current';
        const wrap = document.getElementById('simpleExpireWrap');
        if (wrap){ if (sv==='fixed'){ wrap.classList.add('hidden'); } else { wrap.classList.remove('hidden'); } }
        if (pt){ pt.onchange = (e)=>{ const v=e.target.value; const w=document.getElementById('simpleExpireWrap'); if (w){ if (v==='fixed'){ w.classList.add('hidden'); const et=document.getElementById('simpleExpireTime'); if (et) et.value=''; } else { w.classList.remove('hidden'); } } }; }
        return;
      }

      if (simple) simple.classList.add('hidden');
      if (adv) adv.classList.remove('hidden');

      const rule = rules[index];
      document.getElementById('ruleName').value = rule.name || '';
      const tp = rule.typePrimary || 'custom';
      const ts = rule.typeSecondary || 'normal';
      document.getElementById('ruleTypePrimary').value = tp;
      document.getElementById('ruleTypeSecondary').value = ts;
      applyRuleTypeVisibility(tp);
      document.getElementById('minMultiplier').value = rule.minMultiplier ?? '';
      document.getElementById('maxMultiplier').value = rule.maxMultiplier ?? '';
      updateCurrentSettlementOptions();
      updateFixedSettlementOptions();
      const curType = rule.current?.type || document.getElementById('currentSettlementType').value;
      const fixType = rule.fixed?.type || document.getElementById('fixedSettlementType').value;
      document.getElementById('currentSettlementType').value = curType;
      document.getElementById('fixedSettlementType').value = fixType;
      renderCurrentSettlementFields(curType, rule.current);
      renderFixedSettlementFields(fixType, rule.fixed);
      document.getElementById('splitMethod').value = rule.splitMethod || 'manual';
    }
    function closeModal(){ document.getElementById('modalBackdrop').style.display = 'none'; editIndex = null; }

    function applyRuleTypeVisibility(val){
      const w = document.getElementById('ruleTypeSecondaryWrap');
      const c = document.getElementById('customConfigSection');
      if (val === 'custom') { w.classList.add('hidden'); c.classList.remove('hidden'); }
      else { w.classList.remove('hidden'); c.classList.add('hidden'); }
    }

    function updateCurrentSettlementOptions(){
      const sel = document.getElementById('currentSettlementType');
      sel.innerHTML = '';
      [{v:'order',t:'按订单结算'}, {v:'month',t:'按月结算'}, {v:'year',t:'按年结算'}].forEach(o=>{
        const opt = document.createElement('option'); opt.value=o.v; opt.textContent=o.t; sel.appendChild(opt);
      });
    }
    function updateFixedSettlementOptions(){
      const sel = document.getElementById('fixedSettlementType');
      sel.innerHTML = '';
      [{v:'order',t:'按订单结算'}, {v:'month',t:'按月结算'}, {v:'revenue_end',t:'营收时间结束后统一结算'}].forEach(o=>{
        const opt = document.createElement('option'); opt.value=o.v; opt.textContent=o.t; sel.appendChild(opt);
      });
    }

    function renderCurrentSettlementFields(selectedType, existing){
      const container = document.getElementById('currentSettlementFields');
      container.innerHTML = '';
      const fields = [];
      if (selectedType === 'order'){
        fields.push(`
          <div>
            <label class="label">每笔订单结束后（天）</label>
            <input id="current_orderDays" type="number" min="0" class="input" placeholder="如 7" value="${existing?.orderDays ?? ''}" />
          </div>
        `);
      } else if (selectedType === 'month'){
        fields.push(`
          <div>
            <label class="label">每月结算日（号）</label>
            <input id="current_monthDay" type="number" min="1" max="31" class="input" placeholder="如 25" value="${existing?.monthDay ?? ''}" />
          </div>
        `);
      } else if (selectedType === 'year'){
        fields.push(`
          <div>
            <label class="label">每年结算（月份）</label>
            <input id="current_yearMonth" type="number" min="1" max="12" class="input" placeholder="如 12" value="${existing?.yearMonth ?? ''}" />
          </div>
          <div>
            <label class="label">每年结算（日期）</label>
            <input id="current_yearDay" type="number" min="1" max="31" class="input" placeholder="如 31" value="${existing?.yearDay ?? ''}" />
          </div>
        `);
      }
      container.innerHTML = fields.join('');
    }
    function renderFixedSettlementFields(selectedType, existing){
      const container = document.getElementById('fixedSettlementFields');
      container.innerHTML = '';
      const fields = [];
      if (selectedType === 'order'){
        fields.push(`
          <div>
            <label class="label">每笔订单结束后（天）</label>
            <input id="fixed_orderDays" type="number" min="0" class="input" placeholder="如 7" value="${existing?.orderDays ?? ''}" />
          </div>
        `);
      } else if (selectedType === 'month'){
        fields.push(`
          <div>
            <label class="label">每月结算日（号）</label>
            <input id="fixed_monthDay" type="number" min="1" max="31" class="input" placeholder="如 25" value="${existing?.monthDay ?? ''}" />
          </div>
        `);
      } else if (selectedType === 'revenue_end'){
        fields.push(`
          <div>
            <label class="label">营收结束后（天）结算</label>
            <input id="fixed_revenueEndDays" type="number" min="0" class="input" placeholder="如 15" value="${existing?.revenueEndDays ?? ''}" />
          </div>
        `);
      }
      container.innerHTML = fields.join('');
    }

    function collectCurrentSettlement(selectedType){
      const s = { type: selectedType };
      if (selectedType === 'order'){
        s.orderDays = parseInt(document.getElementById('current_orderDays')?.value || '0', 10) || 0;
      } else if (selectedType === 'month'){
        s.monthDay = parseInt(document.getElementById('current_monthDay')?.value || '1', 10) || 1;
      } else if (selectedType === 'year'){
        s.yearMonth = parseInt(document.getElementById('current_yearMonth')?.value || '1', 10) || 1;
        s.yearDay = parseInt(document.getElementById('current_yearDay')?.value || '1', 10) || 1;
      }
      return s;
    }
    function collectFixedSettlement(selectedType){
      const s = { type: selectedType };
      if (selectedType === 'order'){
        s.orderDays = parseInt(document.getElementById('fixed_orderDays')?.value || '0', 10) || 0;
      } else if (selectedType === 'month'){
        s.monthDay = parseInt(document.getElementById('fixed_monthDay')?.value || '1', 10) || 1;
      } else if (selectedType === 'revenue_end'){
        s.revenueEndDays = parseInt(document.getElementById('fixed_revenueEndDays')?.value || '0', 10) || 0;
      }
      return s;
    }

    // 保存表单
    function onSave(){
      const simple = document.getElementById('simpleNewRuleSection');
      const isSimple = simple && !simple.classList.contains('hidden');
      if (isSimple){
        const name = document.getElementById('simpleRuleName').value.trim();
        const projectType = document.getElementById('simpleProjectType').value;
        const effectiveTime = document.getElementById('simpleEffectiveTime').value;
        let expireTime = document.getElementById('simpleExpireTime').value;
        if (projectType==='fixed'){ expireTime=''; }
        const ledgerScopeType = document.getElementById('simpleLedgerScopeType').value;
        if (!name){ alert('请填写规则名称'); return; }
        const payload = { name, projectType, effectiveTime, expireTime, ledgerScopeType };
        rules.push(payload);
        saveRules(); renderRules(); closeModal();
        return;
      }

      const name = document.getElementById('ruleName').value.trim();
      const typePrimary = document.getElementById('ruleTypePrimary').value;
      const typeSecondary = document.getElementById('ruleTypeSecondary').value;
      if (!name){ alert('请填写规则名称'); return; }
      if (typePrimary !== 'custom'){
        const payload = { name, typePrimary, typeSecondary };
        if (editIndex === null){ rules.push(payload); } else { rules[editIndex] = payload; }
        saveRules(); renderRules(); closeModal();
        return;
      }
      const minMul = parseFloat(document.getElementById('minMultiplier').value);
      const maxMul = parseFloat(document.getElementById('maxMultiplier').value);
      const currentType = document.getElementById('currentSettlementType').value;
      const fixedType = document.getElementById('fixedSettlementType').value;
      const splitMethod = document.getElementById('splitMethod').value;
      if (isNaN(minMul) || isNaN(maxMul)){ alert('请填写保证金额度倍数范围'); return; }
      if (minMul > maxMul){ alert('保证金额度最小值不能大于最大值'); return; }
      const current = collectCurrentSettlement(currentType);
      const fixed = collectFixedSettlement(fixedType);
      const payload = { name, typePrimary, typeSecondary, minMultiplier: minMul, maxMultiplier: maxMul, current, fixed, splitMethod };
      if (editIndex === null){ rules.push(payload); } else { rules[editIndex] = payload; }
      saveRules(); renderRules(); closeModal();
    }

    // 事件绑定与初始化
    document.addEventListener('DOMContentLoaded', () => {
      loadRules(); renderRules();

      document.getElementById('btnAddRule').addEventListener('click', () => openModal(null));
      document.getElementById('btnCloseModal').addEventListener('click', closeModal);
      document.getElementById('btnCancel').addEventListener('click', closeModal);
      document.getElementById('btnSave').addEventListener('click', onSave);
      document.getElementById('ruleTypePrimary').addEventListener('change', (e) => applyRuleTypeVisibility(e.target.value));
      document.getElementById('currentSettlementType').addEventListener('change', (e) => renderCurrentSettlementFields(e.target.value, null));
      document.getElementById('fixedSettlementType').addEventListener('change', (e) => renderFixedSettlementFields(e.target.value, null));

      // 迁移旧数据结构（仅有单一 accountType/settlement 的情形）
      rules = rules.map(r => {
        if (!r.current && !r.fixed && r.settlement){
          if (r.accountType === 'current') r.current = r.settlement; else r.fixed = r.settlement;
          delete r.accountType; delete r.settlement;
        }
        return r;
      });
      saveRules(); renderRules();
    });
  </script>
</body>
</html>
