<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>交易管理</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 p-4">
  <div class="max-w-7xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">交易管理</h1>
    </div>

    <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg mb-4">
      <div class="flex flex-wrap gap-3 items-center">
        <div class="inline-flex items-center border rounded-lg overflow-hidden">
          <span class="px-3 py-2 bg-gray-100 text-sm text-gray-600">项目名称</span>
          <input id="txFilterName" type="text" class="px-3 py-2 text-sm focus:outline-none bg-white dark:bg-gray-700" placeholder="请输入项目名称">
        </div>
        <div class="inline-flex items-center border rounded-lg overflow-hidden">
          <span class="px-3 py-2 bg-gray-100 text-sm text-gray-600">立项时间</span>
          <input id="txFilterDate" type="date" class="px-3 py-2 text-sm focus:outline-none bg-white dark:bg-gray-700">
        </div>
        <div class="inline-flex items-center border rounded-lg overflow-hidden">
          <span class="px-3 py-2 bg-gray-100 text-sm text-gray-600">交易规则</span>
          <select id="txFilterRule" class="px-3 py-2 text-sm focus:outline-none bg-white dark:bg-gray-700">
            <option value="">全部规则</option>
            <option value="门店日常营收分成">门店日常营收分成</option>
            <option value="节假日活动营收分成">节假日活动营收分成</option>
          </select>
        </div>
        <div class="inline-flex items-center gap-2 ml-auto">
          <button id="txBtnSearch" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded"><i class="fas fa-search mr-2"></i>搜索</button>
          <button id="txBtnReset" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded"><i class="fas fa-undo mr-2"></i>重置</button>
        </div>
      </div>
    </div>

    <div id="txCards" class="space-y-3"></div>
    <div id="ruleEditModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
      <div class="bg-white w-full max-w-md rounded-lg shadow-lg">
        <div class="flex items-center justify-between px-4 py-3 border-b">
          <div class="font-medium">修改规则</div>
          <button id="ruleEditClose" class="text-gray-600 px-2 py-1"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-4 space-y-3">
          <div class="inline-flex items-center border rounded-lg overflow-hidden w-full">
            <span class="px-3 py-2 bg-gray-100 text-sm text-gray-600">规则名称</span>
            <select id="ruleEditName" class="px-3 py-2 text-sm focus:outline-none flex-1">
              <option value="门店日常营收分成">门店日常营收分成</option>
              <option value="节假日活动营收分成">节假日活动营收分成</option>
            </select>
          </div>
          <div class="inline-flex items-center border rounded-lg overflow-hidden w-full">
            <span class="px-3 py-2 bg-gray-100 text-sm text-gray-600">生效时间</span>
            <input id="ruleEditStart" type="datetime-local" class="px-3 py-2 text-sm focus:outline-none flex-1" />
          </div>
        </div>
        <div class="flex items-center justify-end gap-2 px-4 py-3 border-t">
          <button id="ruleEditCancel" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded">取消</button>
          <button id="ruleEditConfirm" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">确定</button>
        </div>
      </div>
    </div>
    <div id="reuseModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
      <div class="bg-white w-full max-w-md rounded-lg shadow-lg">
        <div class="flex items-center justify-between px-4 py-3 border-b">
          <div class="font-medium">复用规则</div>
          <button id="reuseClose" class="text-gray-600 px-2 py-1"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-4 space-y-3">
          <div class="inline-flex items-center border rounded-lg overflow-hidden w-full">
            <span class="px-3 py-2 bg-gray-100 text-sm text-gray-600">生效时间</span>
            <input id="reuseStart" type="datetime-local" class="px-3 py-2 text-sm focus:outline-none flex-1" />
          </div>
          <div class="inline-flex items-center border rounded-lg overflow-hidden w-full">
            <span class="px-3 py-2 bg-gray-100 text-sm text-gray-600">失效时间</span>
            <input id="reuseEnd" type="datetime-local" class="px-3 py-2 text-sm focus:outline-none flex-1" />
          </div>
        </div>
        <div class="flex items-center justify-end gap-2 px-4 py-3 border-t">
          <button id="reuseCancel" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded">取消</button>
          <button id="reuseConfirm" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">确定</button>
        </div>
      </div>
    </div>
    <div id="terminateModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
      <div class="bg-white w-full max-w-lg rounded-lg shadow-lg">
        <div class="flex items-center justify-between px-4 py-3 border-b">
          <div class="font-medium">终止分账</div>
          <button id="terminateClose" class="text-gray-600 px-2 py-1"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-4 space-y-3">
          <div class="flex items-center gap-4">
            <label class="inline-flex items-center gap-2"><input type="radio" name="termType" id="termTypeOrder" value="order" checked><span>按订单结算</span></label>
            <label class="inline-flex items-center gap-2"><input type="radio" name="termType" id="termTypeCycle" value="cycle"><span>按年/按月结算</span></label>
          </div>
          <div id="termOrderGroup" class="space-y-3">
            <div class="inline-flex items-center border rounded-lg overflow-hidden w-full">
              <span class="px-3 py-2 bg-gray-100 text-sm text-gray-600">结算时间</span>
              <input type="text" id="termOrderRule" class="px-3 py-2 text-sm focus:outline-none flex-1" value="每笔订单结束后7天" disabled>
            </div>
            <div class="inline-flex items-center border rounded-lg overflow-hidden w-full">
              <span class="px-3 py-2 bg-gray-100 text-sm text-gray-600">入账终止时间</span>
              <input type="datetime-local" id="termOrderStop" class="px-3 py-2 text-sm focus:outline-none flex-1">
            </div>
            <div class="text-xs text-gray-600">此时间之后的订单不纳入分账范围</div>
          </div>
          <div id="termCycleGroup" class="space-y-3 hidden">
            <div class="inline-flex items-center border rounded-lg overflow-hidden w-full">
              <span class="px-3 py-2 bg-gray-100 text-sm text-gray-600">结算方式</span>
              <input type="text" id="termCycleMethod" class="px-3 py-2 text-sm focus:outline-none flex-1" value="按月结算——每月5日" disabled>
            </div>
            <div class="inline-flex items-center border rounded-lg overflow-hidden w-full">
              <span class="px-3 py-2 bg-gray-100 text-sm text-gray-600">第 n 次后终止</span>
              <input type="number" id="termCycleN" min="1" step="1" value="1" class="px-3 py-2 text-sm focus:outline-none w-24 text-right">
            </div>
            <div class="inline-flex items-center border rounded-lg overflow-hidden w-full">
              <span class="px-3 py-2 bg-gray-100 text-sm text-gray-600">分账终止时间</span>
              <input type="datetime-local" id="termCycleStop" class="px-3 py-2 text-sm focus:outline-none flex-1" disabled>
            </div>
          </div>
        </div>
        <div class="flex items-center justify-end gap-2 px-4 py-3 border-t">
          <button id="terminateCancel" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded">取消</button>
          <button id="terminateConfirm" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">确定</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const txMgmtData = [
      { id: 'PRJ-001', name: '星力展厅店营收', created: '2025-11-01 10:00', rule: '门店日常营收分成' },
      { id: 'PRJ-002', name: '华北地区太鼓达人利润', created: '2025-11-05 09:30', rule: '门店日常营收分成' },
      { id: 'PRJ-003', name: '全门店通用10次票营收', created: '2025-11-10 14:20', rule: '节假日活动营收分成' },
      { id: 'PRJ-004', name: '春节联欢票抖音渠道营收', created: '2025-11-12 16:05', rule: '节假日活动营收分成' }
    ];

    const txHistoryData={
      'PRJ-001':[
        {version:'v1.0',name:'门店日常营收分成',start:'2025-11-01 00:00:00',end:'2025-11-10 23:59:59',status:'已失效'},
        {version:'v1.1',name:'门店日常营收分成',start:'2025-11-11 00:00:00',end:'2025-11-20 23:59:59',status:'已失效'},
        {version:'v1.2',name:'门店日常营收分成',start:'2025-11-21 00:00:00',end:'',status:'生效中'}
      ],
      'PRJ-002':[
        {version:'v2.0',name:'门店日常营收分成',start:'2025-11-05 00:00:00',end:'',status:'待生效'}
      ],
      'PRJ-003':[
        {version:'v3.0',name:'节假日活动营收分成',start:'2025-11-10 00:00:00',end:'2025-11-18 23:59:59',status:'已失效'},
        {version:'v3.1',name:'节假日活动营收分成',start:'2025-11-19 00:00:00',end:'',status:'生效中'}
      ],
      'PRJ-004':[
        {version:'v4.0',name:'节假日活动营收分成',start:'2025-11-12 00:00:00',end:'',status:'生效中'}
      ]
    };

    function renderTxCards(list){
      const cont=document.getElementById('txCards');
      if(!cont) return;
      cont.innerHTML=(list||[]).map(p=>{
        const rows=(txHistoryData[p.id]||[]).map(r=>
          `<tr>
            <td class="px-4 py-2 text-sm">${r.version}</td>
            <td class="px-4 py-2 text-sm">${r.name}</td>
            <td class="px-4 py-2 text-sm">${r.start}</td>
            <td class="px-4 py-2 text-sm">${r.end||'—'}</td>
            <td class="px-4 py-2 text-sm">${r.status}</td>
            <td class="px-4 py-2 text-sm">${r.status==='已失效' ? `<div class=\"flex items-center gap-2\"><button class=\"px-2 py-1 rounded border border-blue-200 text-blue-700 hover:bg-blue-50\" data-action=\"view\" data-project=\"${p.id}\" data-version=\"${r.version}\">查看详情</button><button class=\"tx-reuse-rule px-2 py-1 bg-blue-600 text-white rounded\" data-project=\"${p.id}\" data-version=\"${r.version}\">复用</button></div>` : `<button class="px-2 py-1 rounded border border-blue-200 text-blue-700 hover:bg-blue-50" data-action="view" data-project="${p.id}" data-version="${r.version}">查看详情</button>`}</td>
          </tr>`
        ).join('');
        return `
        <div class="border rounded-lg overflow-hidden bg-white dark:bg-gray-800">
          <div class="flex items-center justify-between px-4 py-3 bg-gray-50 dark:bg-gray-900">
            <div class="flex items-center gap-6">
              <div class="font-medium text-gray-800 dark:text-gray-100">${p.name}</div>
              <div class="text-sm text-gray-600 dark:text-gray-300">${p.created}</div>
            </div>
            <div class="flex items-center gap-2">
              <button class="tx-card-toggle px-3 py-1 bg-white dark:bg-gray-800 border rounded" data-id="${p.id}"><i class="fas fa-chevron-down"></i></button>
            </div>
          </div>
          <div class="tx-card-body hidden" data-id="${p.id}">
            <div class="px-4 py-2 flex items-center gap-2">
              <button class="tx-edit-rule px-3 py-1 bg-blue-600 text-white rounded" data-id="${p.id}">修改规则</button>
              <button class="tx-terminate-alloc px-3 py-1 bg-red-600 text-white rounded" data-id="${p.id}">终止分账</button>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-900">
                  <tr>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400">版本号</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400">规则名称</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400">规则生效时间</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400">规则失效时间</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400">状态</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400">操作</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          </div>
        </div>`;
      }).join('');
      document.querySelectorAll('.tx-card-toggle').forEach(b=>{
        b.onclick=function(){
          const id=this.getAttribute('data-id');
          const body=document.querySelector(`.tx-card-body[data-id="${id}"]`);
          if(body) body.classList.toggle('hidden');
        };
      });
      document.querySelectorAll('.tx-edit-rule').forEach(b=>{
        b.onclick=function(){
          const pid=this.getAttribute('data-id');
          openRuleEdit(pid);
        };
      });
      document.querySelectorAll('.tx-terminate-alloc').forEach(b=>{
        b.onclick=function(){
          const pid=this.getAttribute('data-id');
          openTerminate(pid);
        };
      });
      document.querySelectorAll('.tx-reuse-rule').forEach(b=>{
        b.onclick=function(){
          const pid=this.getAttribute('data-project');
          const ver=this.getAttribute('data-version');
          openReuse(pid,ver);
        };
      });
      document.querySelectorAll('button[data-action="view"]').forEach(b=>{
        b.onclick=function(){
          const v=this.getAttribute('data-version');
          const pid=this.getAttribute('data-project');
          alert(`项目 ${pid} 版本 ${v} 详情`);
        };
      });
    }

    function applyTxFilter(){
      const name = (document.getElementById('txFilterName')?.value||'').trim();
      const date = document.getElementById('txFilterDate')?.value||'';
      const rule = document.getElementById('txFilterRule')?.value||'';
      const list = txMgmtData.filter(p=>{
        const okName = name ? p.name.includes(name) : true;
        const okRule = rule ? p.rule===rule : true;
        let okDate = true;
        if(date){
          const d = new Date(date);
          const pc = new Date(p.created.replace(/-/g,'/'));
          okDate = pc >= d;
        }
        return okName && okRule && okDate;
      });
      renderTxCards(list);
    }

    function resetTxFilter(){
      const n=document.getElementById('txFilterName'); if(n) n.value='';
      const d=document.getElementById('txFilterDate'); if(d) d.value='';
      const r=document.getElementById('txFilterRule'); if(r) r.value='';
      renderTxCards(txMgmtData);
    }

    document.getElementById('txBtnSearch').onclick = applyTxFilter;
    document.getElementById('txBtnReset').onclick = resetTxFilter;
    renderTxCards(txMgmtData);

    let ruleEditProjectId=null;
    function pad(n){return (n<10?'0':'')+n}
    function nowLocalForInput(){const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`}
    function toDisplayDateTime(v){ if(!v) return ''; const d=new Date(v); if(isNaN(d)) return v; return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:00` }
    function nextVersionFor(list){
      if(!Array.isArray(list) || !list.length) return 'v1.0';
      const last=list[list.length-1].version||'v1.0';
      const m=last.match(/^v(\d+)\.(\d+)$/);
      if(!m) return 'v1.0';
      const major=parseInt(m[1],10)||1; const minor=parseInt(m[2],10)||0;
      return `v${major}.${minor+1}`;
    }
    function openRuleEdit(pid){
      ruleEditProjectId=pid;
      const proj=txMgmtData.find(x=>x.id===pid);
      const name=proj?proj.rule:((txHistoryData[pid]||[])[0]?.name||'门店日常营收分成');
      const modal=document.getElementById('ruleEditModal');
      document.getElementById('ruleEditName').value=name;
      document.getElementById('ruleEditStart').value=nowLocalForInput();
      modal.classList.remove('hidden');
    }
    function closeRuleEdit(){ document.getElementById('ruleEditModal').classList.add('hidden'); }
    document.getElementById('ruleEditClose').onclick=closeRuleEdit;
    document.getElementById('ruleEditCancel').onclick=closeRuleEdit;
    document.getElementById('ruleEditConfirm').onclick=function(){
      const pid=ruleEditProjectId; if(!pid) return;
      const name=document.getElementById('ruleEditName').value||'';
      const startStr=document.getElementById('ruleEditStart').value||'';
      const startDate=new Date(startStr);
      const now=new Date();
      const status = (startDate>now)?'待生效':'生效中';
      const list = txHistoryData[pid] || (txHistoryData[pid]=[]);
      if(status==='生效中'){
        for(let i=list.length-1;i>=0;i--){ if(list[i].status==='生效中'){ list[i].status='已失效'; list[i].end=toDisplayDateTime(startStr); break; } }
      }
      const version=nextVersionFor(list);
      list.push({version, name, start: toDisplayDateTime(startStr), end:'', status});
      const proj=txMgmtData.find(x=>x.id===pid); if(proj) proj.rule=name;
      closeRuleEdit();
      renderTxCards(txMgmtData);
    };

    let reuseProjectId=null, reuseVersionId=null;
    function openReuse(pid,ver){
      reuseProjectId=pid; reuseVersionId=ver;
      document.getElementById('reuseStart').value=nowLocalForInput();
      document.getElementById('reuseEnd').value='';
      document.getElementById('reuseModal').classList.remove('hidden');
    }
    function closeReuse(){ document.getElementById('reuseModal').classList.add('hidden'); }
    document.getElementById('reuseClose').onclick=closeReuse;
    document.getElementById('reuseCancel').onclick=closeReuse;
    document.getElementById('reuseConfirm').onclick=function(){
      const pid=reuseProjectId; const ver=reuseVersionId; if(!pid||!ver) return;
      const startStr=document.getElementById('reuseStart').value||'';
      const endStr=document.getElementById('reuseEnd').value||'';
      const startDate=new Date(startStr);
      const endDate=endStr?new Date(endStr):null;
      const now=new Date();
      let status='生效中';
      if(startDate>now) status='待生效'; else if(endDate && endDate<=now) status='已失效';
      const list = txHistoryData[pid] || (txHistoryData[pid]=[]);
      if(status==='生效中'){
        for(let i=list.length-1;i>=0;i--){ if(list[i].status==='生效中'){ list[i].status='已失效'; list[i].end=toDisplayDateTime(startStr); break; } }
      }
      const reused=list.find(x=>x.version===ver);
      const name=reused?reused.name:'';
      const version=nextVersionFor(list);
      list.push({version, name, start: toDisplayDateTime(startStr), end: endStr?toDisplayDateTime(endStr):'', status});
      const proj=txMgmtData.find(x=>x.id===pid); if(proj) proj.rule=name;
      closeReuse();
      renderTxCards(txMgmtData);
    };

    let terminateProjectId=null;
    function pad2(n){return (n<10?'0':'')+n}
    function formatInputDate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}` }
    function nextMonthlyStop(n, day){
      const now=new Date();
      let first=new Date(now.getFullYear(), now.getMonth(), day, 0, 0, 0);
      if(first<=now) first=new Date(now.getFullYear(), now.getMonth()+1, day, 0, 0, 0);
      const target=new Date(first.getFullYear(), first.getMonth()+ (n-1), day, 0, 0, 0);
      return formatInputDate(target);
    }
    function openTerminate(pid){
      terminateProjectId=pid;
      const m=document.getElementById('terminateModal');
      document.getElementById('termTypeOrder').checked=true;
      document.getElementById('termOrderGroup').classList.remove('hidden');
      document.getElementById('termCycleGroup').classList.add('hidden');
      document.getElementById('termOrderStop').value='';
      document.getElementById('termCycleN').value='1';
      document.getElementById('termCycleStop').value=nextMonthlyStop(1,5);
      m.classList.remove('hidden');
    }
    function closeTerminate(){ document.getElementById('terminateModal').classList.add('hidden'); }
    document.getElementById('terminateClose').onclick=closeTerminate;
    document.getElementById('terminateCancel').onclick=closeTerminate;
    document.getElementById('termTypeOrder').onchange=function(){
      document.getElementById('termOrderGroup').classList.remove('hidden');
      document.getElementById('termCycleGroup').classList.add('hidden');
    };
    document.getElementById('termTypeCycle').onchange=function(){
      document.getElementById('termOrderGroup').classList.add('hidden');
      document.getElementById('termCycleGroup').classList.remove('hidden');
      const n=parseInt(document.getElementById('termCycleN').value||'1',10)||1;
      document.getElementById('termCycleStop').value=nextMonthlyStop(n,5);
    };
    document.getElementById('termCycleN').addEventListener('input',function(){
      const n=parseInt(this.value||'1',10)||1;
      document.getElementById('termCycleStop').value=nextMonthlyStop(n,5);
    });
    document.getElementById('terminateConfirm').onclick=function(){
      const type=document.getElementById('termTypeOrder').checked?'order':'cycle';
      if(type==='order'){
        const v=document.getElementById('termOrderStop').value||'';
        alert((terminateProjectId||'')+" 入账终止时间设置为 "+(v||'未选择'));
      }else{
        const n=parseInt(document.getElementById('termCycleN').value||'1',10)||1;
        const v=document.getElementById('termCycleStop').value||'';
        alert((terminateProjectId||'')+" 从现在起第 "+n+" 次分账后终止，时间为 "+v);
      }
      closeTerminate();
    };
  </script>
</body>
</html>
