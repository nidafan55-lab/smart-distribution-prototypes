<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>查看流水</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200">
  <div class="p-4 space-y-4">
    <div class="flex items-center justify-between">
      <div class="text-lg font-medium">账户名称：<span id="flowAccountName" class="font-semibold"></span></div>
      <div class="space-x-2">
        <button id="btnExport" class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded"><i class="fas fa-file-export mr-1"></i>导出</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-10 gap-4">
      <div class="flex items-center border rounded-lg overflow-hidden w-full md:col-span-4">
        <span class="px-3 py-2 bg-gray-100 dark:bg-gray-900 text-sm text-gray-600 dark:text-gray-300 whitespace-nowrap flex-shrink-0">交易类型</span>
        <select id="filterType" class="px-3 h-10 text-sm focus:outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 flex-1 min-w-0">
            <option value="">全部</option>
        <option value="ledger">账目流水</option>
        <option value="deposit">保证金</option>
        </select>
      </div>
      <div class="flex items-center border rounded-lg overflow-hidden w-full md:col-span-6">
        <span class="px-3 py-2 bg-gray-100 dark:bg-gray-900 text-sm text-gray-600 dark:text-gray-300 whitespace-nowrap flex-shrink-0">交易时间</span>
        <input id="filterStart" type="datetime-local" class="px-3 h-10 text-sm focus:outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 w-40 md:w-56">
        <span class="px-2 text-sm text-gray-500">—</span>
        <input id="filterEnd" type="datetime-local" class="px-3 h-10 text-sm focus:outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 w-40 md:w-56">
      </div>
      <div class="flex items-center border rounded-lg overflow-hidden w-full md:col-span-10">
        <span class="px-3 py-2 bg-gray-100 dark:bg-gray-900 text-sm text-gray-600 dark:text-gray-300 whitespace-nowrap flex-shrink-0">交易状态</span>
        <select id="filterStatus" class="px-3 h-10 text-sm focus:outline-none bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 flex-1 min-w-0">
          <option value="">全部</option>
          <option value="success">交易成功</option>
          <option value="failed">交易失败</option>
          <option value="pending">处理中</option>
        </select>
      </div>
    </div>

    <div class="overflow-x-auto border rounded">
      <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
        <thead class="bg-gray-50 dark:bg-gray-800">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400">账户名称</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400">交易号</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400">交易时间</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400">交易类型</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400">转入/转出</th>
            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400">流水金额</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400">交易状态</th>
          </tr>
        </thead>
        <tbody id="flowTbody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
      </table>
    </div>

    <div class="flex items-center justify-between mt-3">
      <div class="text-sm text-gray-600 dark:text-gray-300" id="pagerInfo"></div>
      <div class="space-x-2">
        <button id="pagerPrev" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded">上一页</button>
        <button id="pagerNext" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded">下一页</button>
      </div>
    </div>
  </div>

  <script>
    function qs(k){ const u=new URL(window.location.href); return u.searchParams.get(k)||''; }
    const accountName = qs('accountName');
    const accEl = document.getElementById('flowAccountName');
    if(accEl) accEl.textContent = accountName || '';

    const data = [
      { acc: accountName||'集团总经理', no:'TX-202511-0001', time:'2025-11-20 10:12:00', type:'ledger', io:'转入', amount: 12000.00, status:'success' },
      { acc: accountName||'集团总经理', no:'TX-202511-0002', time:'2025-11-20 14:05:22', type:'ledger', io:'转出', amount: -3000.00, status:'success' },
      { acc: accountName||'集团总经理', no:'TX-202511-0003', time:'2025-11-21 09:33:15', type:'deposit', io:'转入', amount: 5000.00, status:'pending' },
      { acc: accountName||'集团总经理', no:'TX-202511-0004', time:'2025-11-22 18:01:03', type:'ledger', io:'转入', amount: 880.00, status:'failed' },
      { acc: accountName||'集团总经理', no:'TX-202511-0005', time:'2025-11-23 12:45:18', type:'deposit', io:'转出', amount: -1200.00, status:'success' }
    ];

    const filterType = document.getElementById('filterType');
    const filterStart = document.getElementById('filterStart');
    const filterEnd = document.getElementById('filterEnd');
    const filterStatus = document.getElementById('filterStatus');
    const flowTbody = document.getElementById('flowTbody');
    const pagerInfo = document.getElementById('pagerInfo');
    const pagerPrev = document.getElementById('pagerPrev');
    const pagerNext = document.getElementById('pagerNext');
    const btnExport = document.getElementById('btnExport');

    let page = 1;
    const pageSize = 5;

    function toTime(v){
      const d=new Date(v.replace(/-/g,'/')); if(isNaN(d)) return null; return d.getTime();
    }
    function fmtAmount(a){
      const s = Number(a).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
      return (a<0?'-':'')+'¥'+s.replace(/^-/,'');
    }
    function render(){
      const t = (filterType.value||'').trim();
      const s = filterStart.value ? toTime(filterStart.value) : null;
      const e = filterEnd.value ? toTime(filterEnd.value) : null;
      const st = (filterStatus.value||'').trim();
      const rows = data.filter(x=>{
        const okT = t? x.type===t : true;
        const ts = toTime(x.time);
        const okS = s? (ts>=s) : true;
        const okE = e? (ts<=e) : true;
        const okSt = st? x.status===st : true;
        return okT && okS && okE && okSt;
      });
      const total = rows.length;
      const pages = Math.max(1, Math.ceil(total / pageSize));
      if(page>pages) page=pages;
      const start=(page-1)*pageSize;
      const pageRows = rows.slice(start, start+pageSize);
      flowTbody.innerHTML = pageRows.map(x=>
        `<tr>
          <td class="px-4 py-2 text-sm">${x.acc}</td>
          <td class="px-4 py-2 text-sm">${x.no}</td>
          <td class="px-4 py-2 text-sm">${x.time}</td>
          <td class="px-4 py-2 text-sm">${x.type==='ledger'?'账目流水':'保证金'}</td>
          <td class="px-4 py-2 text-sm">${x.io}</td>
          <td class="px-4 py-2 text-sm text-right">${fmtAmount(x.amount)}</td>
          <td class="px-4 py-2 text-sm">${x.status==='success'?'交易成功':(x.status==='failed'?'交易失败':'处理中')}</td>
        </tr>`
      ).join('');
      pagerInfo.textContent = `共 ${total} 条，当前第 ${page} / ${pages} 页`;
    }

    filterType.addEventListener('change', function(){ page=1; render(); });
    filterStatus.addEventListener('change', function(){ page=1; render(); });
    filterStart.addEventListener('change', function(){ page=1; render(); });
    filterEnd.addEventListener('change', function(){ page=1; render(); });
    pagerPrev.addEventListener('click', function(){ if(page>1){ page--; render(); } });
    pagerNext.addEventListener('click', function(){ page++; render(); });

    btnExport.addEventListener('click', function(){
      const headers = ['账户名称','交易号','交易时间','交易类型','转入/转出','流水金额','交易状态'];
      const t = (filterType.value||'').trim();
      const s = filterStart.value ? toTime(filterStart.value) : null;
      const e = filterEnd.value ? toTime(filterEnd.value) : null;
      const st = (filterStatus.value||'').trim();
      const rows = data.filter(x=>{
        const okT = t? x.type===t : true;
        const ts = toTime(x.time);
        const okS = s? (ts>=s) : true;
        const okE = e? (ts<=e) : true;
        const okSt = st? x.status===st : true;
        return okT && okS && okE && okSt;
      });
      const csv = [headers.join(',')].concat(rows.map(x=>[
        x.acc,
        x.no,
        x.time,
        x.type==='ledger'?'账目流水':'保证金',
        x.io,
        x.amount,
        x.status==='success'?'交易成功':(x.status==='failed'?'交易失败':'处理中')
      ].join(','))).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download=`${(accountName||'账户')}-流水.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    render();
  </script>
</body>
</html>
